<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Precificação • {{ produto.nome }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    :root{ --ink:#0f172a; --muted:#64748b; --ring:rgba(37,99,235,.18); --g1:#0b1020; --g2:#111a3a; --base-font:14px; }
    html{ font-size: var(--base-font); } body{ background:#f6f8fb; color:var(--ink); }
    .nav-pro{ background:linear-gradient(90deg,var(--g1),var(--g2)); } .navbar-brand{ font-size:1rem; }
    .navbar .btn{ font-size:.85rem; padding:.25rem .5rem; }
    .kpi{ background:#fff; border:1px solid #e5e7eb; border-radius:.8rem; padding:.75rem 1rem; }
    .kpi .small{ color:var(--muted); font-size:.8rem; } .kpi .fs-4{ font-size:1.15rem!important; } .kpi .fw-bold{ font-weight:700!important; }
    .card-clean{ border:none; box-shadow:0 10px 24px rgba(17,24,39,.08); border-radius:.9rem; }
    .text-muted-2{ color:var(--muted); }
    .table thead th{ font-size:.78rem; text-transform:uppercase; letter-spacing:.04em; color:#64748b; background:#f8fafc; }
    .tfoot-strong th, .tfoot-strong td{ border-top:2px solid #0b1020; font-weight:800; }
    .badge-soft{ background:#eef2f7; color:#0f172a; border:1px solid #e5e7eb; }
    .no-print{ display:block; }
    @media print{
      @page{ size:auto; margin:14mm; }
      .no-print{ display:none!important; }
      .card-clean{ box-shadow:none; border:1px solid #e5e7eb; }
      a[href]:after{ content:""; }
    }
  </style>
</head>
<body>
{% url 'home' as home_url %}
{% url 'precificacao:dashboard' as dash_url %}

<nav class="navbar nav-pro navbar-dark">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold" href="{{ home_url|default:'#' }}">YLA Criativa</a>
    <div class="d-flex align-items-center gap-2 ms-auto">
      <a class="btn btn-sm btn-light" href="{{ dash_url|default:'#' }}">Painel</a>
      <button class="btn btn-sm btn-primary no-print" onclick="window.print()">Imprimir</button>
    </div>
  </div>
</nav>

<main class="container py-3 py-lg-4">
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-2">
    <h1 class="h5 m-0">{{ produto.nome }}</h1>
    <div class="text-muted-2 small">
      Código: {{ produto.codigo|default:"—" }} • Ativo: {{ produto.ativo|yesno:"Sim,Não" }}
    </div>
  </div>

  <!-- KPIs de topo -->
  <div class="row g-3 mb-3">
    <div class="col-6 col-md-3">
      <div class="kpi">
        <div class="small">Materiais</div>
        <div class="fs-4 fw-bold">R$ {{ bd.materiais|floatformat:2 }}</div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="kpi">
        <div class="small">Mão de obra</div>
        <div class="fs-4 fw-bold">R$ {{ bd.mao_de_obra|floatformat:2 }}</div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="kpi">
        <div class="small">Tinta</div>
        <div class="fs-4 fw-bold">R$ {{ bd.tinta|floatformat:2 }}</div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="kpi">
        <div class="small">Custo total</div>
        <div class="fs-4 fw-bold">R$ {{ bd.custo_total|floatformat:2 }}</div>
      </div>
    </div>
  </div>

  <!-- Materiais detalhados (com ALERTA VISUAL) -->
  <div class="card card-clean p-3 mb-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h2 class="h6 m-0">Materiais (por componente)</h2>
      <span class="badge badge-soft">Total materiais: R$ {{ total_materiais|floatformat:2 }}</span>
    </div>

    {% if alerts %}
      <div class="alert alert-warning d-flex align-items-start gap-2" role="alert">
        <div class="mt-1">⚠️</div>
        <div>
          <strong>Atenção:</strong> Encontramos {{ alerts|length }} possível(is) problema(s).
          <ul class="mb-0">
            {% for a in alerts %}
              <li><strong>{{ a.mp_nome }}</strong>: {{ a.msg }}</li>
            {% endfor %}
          </ul>
        </div>
      </div>
    {% endif %}

    <div class="table-responsive">
      <table class="table align-middle bg-white rounded-3 overflow-hidden">
        <thead>
          <tr>
            <th style="width:12%">Status</th>
            <th>Matéria-prima</th>
            <th style="width:10%">Un. base</th>
            <th style="width:14%" class="text-end">Custo unit.</th>
            <th style="width:14%" class="text-end">Qtd. uso</th>
            <th style="width:12%" class="text-end">% Perda</th>
            <th style="width:14%" class="text-end">Qtd. efetiva</th>
            <th style="width:14%" class="text-end">Subtotal</th>
          </tr>
        </thead>
        <tbody>
          {% for r in comp_rows %}
            <tr class="{% if r.alert %}table-warning{% endif %}">
              <td class="text-center">
                {% if r.alert %}
                  <span class="badge text-bg-warning">⚠️ Verificar</span>
                  <div class="small text-muted">{{ r.alert_msg }}</div>
                {% else %}
                  <span class="badge text-bg-success">OK</span>
                {% endif %}
              </td>
              <td class="fw-semibold">{{ r.mp_nome }}</td>
              <td>{{ r.un_base }}</td>
              <td class="text-end">R$ {{ r.unit|floatformat:4 }}</td>
              <td class="text-end">{{ r.qtd|floatformat:4 }}</td>
              <td class="text-end">{{ r.perda|floatformat:2 }}%</td>
              <td class="text-end">{{ r.qtd_efetiva|floatformat:4 }}</td>
              <td class="text-end">R$ {{ r.subtotal|floatformat:2 }}</td>
            </tr>
          {% empty %}
            <tr><td colspan="8" class="text-muted-2">Sem componentes cadastrados.</td></tr>
          {% endfor %}
        </tbody>
        <tfoot>
          <tr class="tfoot-strong">
            <th colspan="7" class="text-end">Total</th>
            <th class="text-end">R$ {{ total_materiais|floatformat:2 }}</th>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>

  <!-- Mão de obra e fixos -->
  <div class="card card-clean p-3 mb-3">
    <h2 class="h6 mb-2">Mão de obra e fixos</h2>
    <div class="row g-3">
      <div class="col-md-6">
        <div class="table-responsive">
          <table class="table align-middle">
            <tbody>
              <tr><th style="width:60%">Renda mensal desejada</th><td>R$ {{ renda_mensal|floatformat:2 }}</td></tr>
              <tr><th>Horas no mês</th><td>{{ horas_mes|floatformat:4 }} h</td></tr>
              <tr><th>Custo mão de obra / hora</th><td>R$ {{ mao_hora|floatformat:4 }}</td></tr>
              <tr><th>Fixos rateados / hora</th><td>R$ {{ fixos_hora|floatformat:4 }}</td></tr>
              <tr><th>Custo total / hora</th><td>R$ {{ custo_hora_total|floatformat:4 }}</td></tr>
              <tr><th>Custo total / minuto</th><td>R$ {{ custo_minuto_total|floatformat:4 }}</td></tr>
              <tr><th>Tempo do produto</th><td>{{ tempo_min|floatformat:0 }} min</td></tr>
              <tr class="tfoot-strong"><th>Custo de mão de obra</th><td>R$ {{ custo_mo|floatformat:2 }}</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="col-md-6">
        <div class="kpi mb-2">
          <div class="small">Tinta (por %)</div>
          {% if usa_tinta %}
            <div>Parâmetro: R$ {{ tinta_custo_pct|floatformat:2 }} por 1%</div>
            <div>Percentual no produto: {{ tinta_pct|floatformat:2 }}%</div>
            <div class="fs-6 fw-bold mt-1">Custo de tinta: R$ {{ custo_tinta|floatformat:2 }}</div>
          {% else %}
            <div class="text-muted-2">Produto não usa percentual de tinta.</div>
          {% endif %}
        </div>
        <div class="kpi">
          <div class="small">Resumo do custo (do service)</div>
          <div>Materiais: R$ {{ bd.materiais|floatformat:2 }}</div>
          <div>Mão de obra: R$ {{ bd.mao_de_obra|floatformat:2 }}</div>
          <div>Tinta: R$ {{ bd.tinta|floatformat:2 }}</div>
          <div class="fs-6 fw-bold mt-1">Custo total: R$ {{ bd.custo_total|floatformat:2 }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Caminho do preço: margem + impostos + taxa + acréscimo + arredondamento -->
  <div class="card card-clean p-3">
    <h2 class="h6 mb-2">Formação do preço</h2>
    <div class="row g-3">
      <div class="col-md-6">
        <div class="table-responsive">
          <table class="table align-middle">
            <tbody>
              <tr><th style="width:60%">Margem aplicada</th><td>{{ margem_usada|floatformat:2 }}%</td></tr>
              <tr><th>Preço sem taxas (custo + margem)</th><td>R$ {{ bd.preco_sem_taxas|floatformat:2 }}</td></tr>
              <tr><th>Impostos</th><td>{{ impostos_pct|floatformat:2 }}% → R$ {{ bd.impostos|floatformat:2 }}</td></tr>
              <tr><th>Taxa cartão</th><td>{{ taxa_cartao_pct|floatformat:2 }}% → R$ {{ bd.taxa_cartao|floatformat:2 }}</td></tr>
              <tr><th>Acréscimo padrão</th><td>{{ acrescimo_pct|floatformat:2 }}% → R$ {{ bd.acrescimo_padrao|floatformat:2 }}</td></tr>
              <tr><th>Arredondamento</th><td>para múltiplos de R$ {{ arredondar_para|floatformat:2 }}</td></tr>
              <tr class="tfoot-strong"><th>Preço final sugerido</th><td>R$ {{ bd.preco_final|floatformat:2 }}</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="col-md-6">
        <div class="kpi">
          <div class="small">Atalhos</div>
          <div class="d-flex flex-wrap gap-2 mt-2">
            <a class="btn btn-success btn-sm" href="{% url 'precificacao:orcamento_create' %}">Usar em um orçamento</a>
            <a class="btn btn-outline-secondary btn-sm" href="{{ dash_url|default:'#' }}">Voltar ao painel</a>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>
</body>
</html>
