<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Pedidos • Loja Digital</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    :root{ --muted:#64748b; }
    body{ background:#f6f8fb; }
    .kpi{ background:#fff; border:1px solid #e5e7eb; border-radius:.75rem; padding:1rem 1.25rem; }
    .badge-pill{ border-radius:999px; padding:.35rem .65rem; font-weight:600; }
  </style>
</head>
<body>
<nav class="navbar navbar-dark" style="background:linear-gradient(90deg,#0b1020,#111a3a);">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold" href="{% url 'home' %}">YLA Criativa</a>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-light btn-sm" href="{% url 'home' %}">Catálogo</a>
      <a class="btn btn-outline-light btn-sm" href="{% url 'orders_list' %}">Pedidos</a>
      {% if user.is_authenticated %}
        <a class="btn btn-outline-light btn-sm" href="{% url 'logout' %}">Sair</a>
      {% else %}
        <a class="btn btn-outline-light btn-sm" href="{% url 'login' %}">Entrar</a>
      {% endif %}
    </div>
  </div>
</nav>

<main class="container py-4">

  <!-- Botão voltar para a Home -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <a class="btn btn-outline-secondary" href="{% url 'home' %}">← Voltar para a Home</a>
  </div>

  {% if messages %}
    <div class="mb-3">
      {% for m in messages %}
        <div class="alert alert-{{ m.tags|default:'info' }} mb-2">{{ m }}</div>
      {% endfor %}
    </div>
  {% endif %}

  <div class="row g-3 mb-3">
    <div class="col-6 col-md-3">
      <div class="kpi">
        <div class="small text-muted">Pedidos</div>
        <div class="fs-4 fw-bold">{{ counts.todos }}</div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="kpi">
        <div class="small text-muted">Pendente</div>
        <div class="fs-4 fw-bold">{{ counts.pending }}</div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="kpi">
        <div class="small text-muted">Ticket médio</div>
        <div class="fs-4 fw-bold">R$ {{ ticket_medio }}</div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="kpi">
        <div class="small text-muted">Receita (30d)</div>
        <div class="fs-4 fw-bold">R$ {{ receita_30 }}</div>
      </div>
    </div>
  </div>

  <form class="row g-2 align-items-end mb-3" method="get">
    <div class="col-12 col-md-4">
      <label class="form-label small text-muted">Buscar</label>
      <input type="search" name="q" value="{{ q }}" class="form-control" placeholder="Cliente, e-mail, CPF, produto ou #id">
    </div>
    <div class="col-6 col-md-3">
      <label class="form-label small text-muted">Status</label>
      <select name="status" class="form-select">
        <option value="" {% if not status %}selected{% endif %}>Todos</option>
        <option value="pending" {% if status == 'pending' %}selected{% endif %}>Pendente</option>
        <option value="paid" {% if status == 'paid' %}selected{% endif %}>Pago</option>
        <option value="cancelled" {% if status == 'cancelled' %}selected{% endif %}>Cancelado</option>
      </select>
    </div>
    <div class="col-6 col-md-2">
      <button class="btn btn-primary w-100">Filtrar</button>
    </div>
    <div class="col-12 col-md-3 text-md-end">
      <a class="btn btn-outline-secondary w-100 w-md-auto" href="{% url 'orders_list' %}">Limpar</a>
    </div>
  </form>

  {% if orders %}
    <div class="table-responsive">
      <table class="table align-middle bg-white rounded-3 overflow-hidden">
        <thead>
          <tr>
            <th>#</th>
            <th>Data</th>
            <th>Cliente</th>
            <th>E-mail</th>
            <th>Produto</th>
            <th>Valor</th>
            <th>Forma</th>
            <th>Status</th>
            <th class="text-end">Ações</th>
          </tr>
        </thead>
        <tbody>
          {% for o in orders %}
            <tr>
              <td class="text-muted">#{{ o.id }}</td>
              <td>{{ o.created_at|date:"d/m/Y H:i" }}</td>
              <td>{{ o.customer.full_name }}</td>
              <td><a href="mailto:{{ o.customer.email }}">{{ o.customer.email }}</a></td>
              <td class="text-truncate" style="max-width:260px;">{{ o.product.title }}</td>
              <td>R$ {{ o.amount }}</td>
              <td>{{ o.get_payment_type_display }}</td>
              <td>
                {% if o.status == 'paid' %}
                  <span class="badge bg-success">Pago</span>
                {% elif o.status == 'pending' %}
                  <span class="badge bg-warning text-dark">Pendente</span>
                {% else %}
                  <span class="badge bg-secondary">Cancelado</span>
                {% endif %}
              </td>
              <td class="text-end">
                {% if o.payment_type == 'pix' %}
                  <a class="btn btn-sm btn-outline-primary" href="{% url 'payment_pending' o.id %}">Ver</a>
                {% else %}
                  <a class="btn btn-sm btn-outline-primary" href="{% url 'pay_card' o.id %}">Checkout</a>
                {% endif %}

                <!-- Lembrar por e-mail -->
                <form action="{% url 'order_send_reminder' o.id %}" method="post" class="d-inline">
                  {% csrf_token %}
                  <input type="hidden" name="next" value="{{ request.get_full_path }}">
                  <button class="btn btn-sm btn-outline-dark" {% if o.status != 'pending' %}disabled{% endif %}>
                    E-mail
                  </button>
                </form>

                <!-- WhatsApp (ao lado) -->
                {% if o.customer.phone %}
                  <a
                    class="btn btn-sm btn-success ms-1 btn-wa"
                    target="_blank" rel="noopener"
                    data-phone="{{ o.customer.phone }}"
                    data-name="{{ o.customer.full_name|default:'' }}"
                    data-order="{{ o.id }}"
                    data-link="{% if o.payment_type == 'pix' %}{% url 'payment_pending' o.id %}{% else %}{% url 'pay_card' o.id %}{% endif %}">
                    WhatsApp
                  </a>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <nav class="mt-3">
      <ul class="pagination mb-0">
        {% if page_obj.has_previous %}
          <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}&q={{ q }}&status={{ status }}">«</a></li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">«</span></li>
        {% endif %}
        <li class="page-item disabled"><span class="page-link">Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span></li>
        {% if page_obj.has_next %}
          <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}&q={{ q }}&status={{ status }}">»</a></li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">»</span></li>
        {% endif %}
      </ul>
    </nav>
  {% else %}
    <div class="alert alert-info">Nenhum pedido encontrado.</div>
  {% endif %}
</main>

<script>
/* monta os links de WhatsApp de forma robusta */
(function(){
  const waBtns = document.querySelectorAll('.btn-wa');
  waBtns.forEach(btn=>{
    const raw = (btn.dataset.phone || '');
    const name = (btn.dataset.name || '').trim();
    const order = btn.dataset.order || '';
    const linkPath = btn.dataset.link || '/';

    // limpa para dígitos
    let num = raw.replace(/\D/g,'');
    if (!num){
      btn.classList.add('disabled');
      btn.setAttribute('aria-disabled','true');
      return;
    }
    // remove zeros à esquerda
    num = num.replace(/^0+/, '');
    // se não começar com 55 e parecer número nacional (10/11 dígitos), prefixa 55
    if (!/^55/.test(num) && (num.length === 10 || num.length === 11)) {
      num = '55' + num;
    }

    const origin = window.location.origin;
    const absLink = linkPath.startsWith('http') ? linkPath : origin + linkPath;

    const greeting = name ? `Olá, ${name}!` : 'Olá!';
    const msg = `${greeting} Aqui é da Loja Yarin Impressõesa. Sobre seu pedido #${order}, segue o link: ${absLink}`;
    const url = new URL(`https://wa.me/${num}`);
    url.searchParams.set('text', msg);

    btn.href = url.toString();
    btn.title = 'Enviar WhatsApp';
  });
})();
</script>
</body>
</html>
