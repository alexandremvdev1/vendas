<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Pedidos ‚Ä¢ Loja Digital</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    :root{ --muted:#64748b; --base-font:14px; }
    html{ font-size: var(--base-font); }
    body{ background:#f6f8fb; }
    .navbar-brand{ font-size:1rem; }
    .navbar .btn{ font-size:.85rem; padding:.25rem .5rem; }

    .kpi{ background:#fff; border:1px solid #e5e7eb; border-radius:.75rem; padding:.6rem .8rem; }
    .kpi .small{ font-size:.8rem; color:var(--muted); }
    .kpi .val{ font-weight:700; font-size:1.05rem; }

    .table{ font-size:.85rem; }
    .table td,.table th{ vertical-align:middle; }
    .table thead th{ white-space:nowrap; }

    .actions-wrap{ display:inline-flex; gap:.35rem; align-items:center; justify-content:flex-end; flex-wrap:nowrap; }
    .btn-icon{ padding:.2rem .4rem; line-height:1; }
    .form-control, .form-select { font-size:.75rem; padding:.25rem .4rem; height:28px; }
    .w-code{ width:120px; }
    .w-carrier{ width:140px; }
    .w-carrier-name{ width:150px; }
    .chip{ font-size:.72rem; border-radius:999px; padding:.15rem .5rem; background:#eef2ff; color:#334155; display:inline-block; }
    .pagination .page-link{ font-size:.8rem; padding:.3rem .55rem; }
  </style>
</head>
<body>
<nav class="navbar navbar-dark" style="background:linear-gradient(90deg,#0b1020,#111a3a);">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold" href="{% url 'home' %}">YLA Criativa</a>
    <div class="d-flex gap-2">
      <a class="btn btn-info btn-sm" href="{% url 'home' %}">Cat√°logo</a>
      <a class="btn btn-secondary btn-sm" href="{% url 'orders_list' %}">Pedidos</a>
      {% if user.is_authenticated %}
        <a class="btn btn-danger btn-sm" href="{% url 'logout' %}">Sair</a>
      {% else %}
        <a class="btn btn-success btn-sm" href="{% url 'login' %}">Entrar</a>
      {% endif %}
    </div>
  </div>
</nav>

<main class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <a class="btn btn-outline-info btn-sm" href="{% url 'home' %}">‚Üê Voltar</a>
  </div>

  {% if messages %}
    <div class="mb-3">
      {% for m in messages %}
        <div class="alert alert-{{ m.tags|default:'info' }} mb-2 small">{{ m }}</div>
      {% endfor %}
    </div>
  {% endif %}

  <div class="row g-3 mb-3">
    <div class="col-6 col-md-3"><div class="kpi"><div class="small">Pedidos</div><div class="val">{{ counts.todos }}</div></div></div>
    <div class="col-6 col-md-3"><div class="kpi"><div class="small">Pendente</div><div class="val">{{ counts.pending }}</div></div></div>
    <div class="col-6 col-md-3"><div class="kpi"><div class="small">Ticket m√©dio</div><div class="val">R$ {{ ticket_medio }}</div></div></div>
    <div class="col-6 col-md-3"><div class="kpi"><div class="small">Receita (30d)</div><div class="val">R$ {{ receita_30 }}</div></div></div>
  </div>

  <form class="row g-2 align-items-end mb-3" method="get">
    <div class="col-12 col-md-5">
      <label class="form-label small text-muted mb-1">Buscar</label>
      <input type="search" name="q" value="{{ q }}" class="form-control" placeholder="Cliente, e-mail, CPF, produto ou #id">
    </div>
    <div class="col-6 col-md-3">
      <label class="form-label small text-muted mb-1">Status (pagamento)</label>
      <select name="status" class="form-select">
        <option value="" {% if not status %}selected{% endif %}>Todos</option>
        <option value="pending" {% if status == 'pending' %}selected{% endif %}>Pendente</option>
        <option value="paid" {% if status == 'paid' %}selected{% endif %}>Pago</option>
        <option value="cancelled" {% if status == 'cancelled' %}selected{% endif %}>Cancelado</option>
      </select>
    </div>
    <div class="col-6 col-md-2"><button class="btn btn-primary w-100">Filtrar</button></div>
    <div class="col-12 col-md-2 text-md-end"><a class="btn btn-dark w-100 w-md-auto" href="{% url 'orders_list' %}">Limpar</a></div>
  </form>

  {% if orders %}
    <div class="table-responsive">
      <table class="table table-sm table-hover bg-white rounded-3 overflow-hidden align-middle">
        <thead class="table-light">
          <tr>
            <th>#</th><th>Data</th><th>Cliente</th><th>E-mail</th><th>Produto</th>
            <th>Valor</th><th>Forma</th><th>Status</th><th class="text-end">A√ß√µes</th>
          </tr>
        </thead>
        <tbody>
          {% for o in orders %}
          <tr>
            <td class="text-muted">#{{ o.id }}</td>
            <td>{{ o.created_at|date:"d/m/Y H:i" }}</td>
            <td>{{ o.customer.full_name }}</td>
            <td><a href="mailto:{{ o.customer.email }}">{{ o.customer.email }}</a></td>
            <td class="text-truncate" style="max-width:260px;" title="{{ o.product.title }}">{{ o.product.title }}</td>
            <td>R$ {{ o.amount }}</td>
            <td>{{ o.get_payment_type_display }}</td>
            <td>
              {% if o.status == 'paid' %}
                <span class="badge bg-success">Pago</span>
              {% elif o.status == 'pending' %}
                <span class="badge bg-warning text-dark">Pendente</span>
              {% else %}
                <span class="badge bg-secondary">Cancelado</span>
              {% endif %}
              {% if o.product.is_physical %}
                {% if o.shipping_status == 'shipped' %}
                  <span class="chip ms-1">Enviado</span>
                {% else %}
                  <span class="chip ms-1">Pend. envio</span>
                {% endif %}
              {% endif %}
            </td>

            <td class="text-end">
              <div class="actions-wrap">

                {% if o.product.is_physical %}
                <form action="{% url 'order_shipping_update' o.id %}" method="post" class="d-inline-flex align-items-center gap-1">
                  {% csrf_token %}
                  <input type="hidden" name="next" value="{{ request.get_full_path }}">

                  <div class="form-check form-switch m-0" title="Marcar como enviado">
                    <input class="form-check-input" type="checkbox" name="shipped" {% if o.shipping_status == 'shipped' %}checked{% endif %}>
                  </div>

                  <input class="form-control form-control-sm w-code"
                         name="tracking_code"
                         value="{{ o.tracking_code|default:'' }}"
                         placeholder="c√≥d.">

                  <select class="form-select form-select-sm w-carrier" name="tracking_carrier" data-target="#carrierName{{ o.id }}">
                    <option value="" {% if not o.tracking_carrier %}selected{% endif %}>Transportadora</option>
                    <option value="Correios" {% if o.tracking_carrier == 'Correios' %}selected{% endif %}>Correios</option>
                    <option value="Jadlog" {% if o.tracking_carrier == 'Jadlog' %}selected{% endif %}>Jadlog</option>
                    <option value="J&T" {% if o.tracking_carrier == 'J&T' %}selected{% endif %}>J&amp;T</option>
                    <option value="Loggi" {% if o.tracking_carrier == 'Loggi' %}selected{% endif %}>Loggi</option>
                    <option value="Sequoia" {% if o.tracking_carrier == 'Sequoia' %}selected{% endif %}>Sequoia</option>
                    <option value="outro" {% if o.tracking_carrier and o.tracking_carrier != 'Correios' and o.tracking_carrier != 'Jadlog' and o.tracking_carrier != 'J&T' and o.tracking_carrier != 'Loggi' and o.tracking_carrier != 'Sequoia' %}selected{% endif %}>Outro‚Ä¶</option>
                  </select>

                  <input class="form-control form-control-sm w-carrier-name"
                         name="carrier_name"
                         id="carrierName{{ o.id }}"
                         value="{% if o.tracking_carrier and o.tracking_carrier != 'Correios' and o.tracking_carrier != 'Jadlog' and o.tracking_carrier != 'J&T' and o.tracking_carrier != 'Loggi' and o.tracking_carrier != 'Sequoia' %}{{ o.tracking_carrier }}{% endif %}"
                         placeholder="Nome transp.">

                  <button class="btn btn-outline-primary btn-sm btn-icon" title="Salvar" aria-label="Salvar">üíæ</button>
                </form>
                {% endif %}

                {% if o.payment_type == 'pix' %}
                  <a class="btn btn-outline-primary btn-sm btn-icon" href="{% url 'payment_pending' o.id %}" title="Ver (Pix)" aria-label="Ver">üëÅÔ∏è</a>
                {% else %}
                  <a class="btn btn-outline-success btn-sm btn-icon" href="{% url 'pay_card' o.id %}" title="Checkout (Cart√£o)" aria-label="Checkout">üí≥</a>
                {% endif %}

                <form action="{% url 'order_send_reminder' o.id %}" method="post" class="d-inline">
                  {% csrf_token %}
                  <input type="hidden" name="next" value="{{ request.get_full_path }}">
                  <button class="btn btn-outline-info btn-sm btn-icon" {% if o.status != 'pending' %}disabled{% endif %} title="Enviar e-mail">‚úâÔ∏è</button>
                </form>

                {% if o.customer.phone %}
                  <a class="btn btn-outline-warning btn-sm btn-icon btn-wa"
                     target="_blank" rel="noopener"
                     data-phone="{{ o.customer.phone }}"
                     data-name="{{ o.customer.full_name|default:'' }}"
                     data-order="{{ o.id }}"
                     data-link="{% if o.payment_type == 'pix' %}{% url 'payment_pending' o.id %}{% else %}{% url 'pay_card' o.id %}{% endif %}"
                     title="WhatsApp" aria-label="WhatsApp">üü¢</a>
                {% endif %}
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <nav class="mt-3">
      <ul class="pagination pagination-sm mb-0">
        {% if page_obj.has_previous %}
          <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}&q={{ q }}&status={{ status }}">¬´</a></li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">¬´</span></li>
        {% endif %}
        <li class="page-item disabled"><span class="page-link">P√°gina {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span></li>
        {% if page_obj.has_next %}
          <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}&q={{ q }}&status={{ status }}">¬ª</a></li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">¬ª</span></li>
        {% endif %}
      </ul>
    </nav>
  {% else %}
    <div class="alert alert-info small">Nenhum pedido encontrado.</div>
  {% endif %}
</main>

<script>
/* Preencher nome da transportadora ao escolher no <select> (sem l√≥gica de template) */
document.addEventListener('change', function(ev){
  const sel = ev.target.closest('select[name="tracking_carrier"]');
  if (!sel) return;
  const target = document.querySelector(sel.getAttribute('data-target'));
  if (!target) return;
  if (sel.value && sel.value !== 'outro') {
    target.value = sel.value;
  } else if (sel.value === 'outro' && !target.value) {
    target.focus();
  }
});

/* Links do WhatsApp compactos */
(function(){
  const waBtns = document.querySelectorAll('.btn-wa');
  waBtns.forEach(btn=>{
    const raw = (btn.dataset.phone || '');
    const name = (btn.dataset.name || '').trim();
    const order = btn.dataset.order || '';
    const linkPath = btn.dataset.link || '/';
    let num = raw.replace(/\D/g,'');
    if (!num){ btn.classList.add('disabled'); btn.setAttribute('aria-disabled','true'); return; }
    num = num.replace(/^0+/, '');
    if (!/^55/.test(num) && (num.length === 10 || num.length === 11)) { num = '55' + num; }
    const origin = window.location.origin;
    const absLink = linkPath.startsWith('http') ? linkPath : origin + linkPath;
    const greeting = name ? `Ol√°, ${name}!` : 'Ol√°!';
    const msg = `${greeting} Aqui √© da YLA Criativa. Sobre seu pedido #${order}, segue o link: ${absLink}`;
    const url = new URL(`https://wa.me/${num}`);
    url.searchParams.set('text', msg);
    btn.href = url.toString();
    btn.title = 'Enviar WhatsApp';
  });
})();
</script>
</body>
</html>
