{% extends "vendas/base.html" %}
{% block title %}Início • Loja Digital{% endblock %}

{% block content %}

<div class="d-flex align-items-center justify-content-between mb-4">
  <h1 class="h4 m-0">Produtos</h1>

  {% if user.is_staff %}
    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary" href="{% url 'admin:vendas_product_changelist' %}">
        Gerenciar no Admin
      </a>
      <a class="btn btn-primary" href="{% url 'admin:vendas_product_add' %}">
        + Cadastrar produto
      </a>
    </div>
  {% endif %}
</div>

{% if products %}
  <div class="row g-4">
    {% for p in products %}
      <div class="col-md-4">
        <div class="card h-100 shadow-sm">
          {% if p.image %}
            <img src="{{ p.image.url }}" class="card-img-top" alt="{{ p.title }}">
          {% else %}
            <div class="card-img-top d-flex align-items-center justify-content-center" style="height:200px; background:#f5f6f8;">
              <span class="text-muted">Sem imagem</span>
            </div>
          {% endif %}

          <div class="card-body d-flex flex-column">
            <h2 class="h6 mb-1">{{ p.title }}</h2>
            <p class="text-muted mb-2">R$ {{ p.price }}</p>
            <p class="flex-grow-1 mb-3">{{ p.description|default:""|truncatewords:24 }}</p>

            <div class="btn-group" role="group">
              <a class="btn btn-primary" href="{{ p.get_checkout_url }}">Ir ao checkout</a>
              <button class="btn btn-outline-secondary js-share"
                      type="button"
                      data-title="{{ p.title }}"
                      data-url="{{ request.scheme }}://{{ request.get_host }}{{ p.get_checkout_url }}">
                Compartilhar
              </button>
              <button class="btn btn-outline-dark js-copy"
                      type="button"
                      data-url="{{ request.scheme }}://{{ request.get_host }}{{ p.get_checkout_url }}">
                Copiar link
              </button>
            </div>

            {% if user.is_staff %}
              <div class="d-flex gap-2 mt-3">
                <a class="btn btn-sm btn-outline-secondary"
                   href="{% url 'admin:vendas_product_change' p.id %}">Editar</a>
                <a class="btn btn-sm btn-outline-secondary"
                   href="{% url 'admin:vendas_order_changelist' %}?product__id__exact={{ p.id }}">Pedidos</a>
              </div>
            {% endif %}
          </div>

          <div class="card-footer bg-white">
            <label class="form-label small mb-1">Link do checkout</label>
            <div class="input-group input-group-sm">
              <input id="url-input-{{ p.id }}" type="text" class="form-control"
                     readonly
                     value="{{ request.scheme }}://{{ request.get_host }}{{ p.get_checkout_url }}">
              <button class="btn btn-outline-secondary js-copy"
                      type="button"
                      data-target="#url-input-{{ p.id }}"
                      data-url="{{ request.scheme }}://{{ request.get_host }}{{ p.get_checkout_url }}">
                Copiar
              </button>
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
{% else %}
  <div class="alert alert-info">Nenhum produto disponível no momento.</div>
  {% if user.is_staff %}
    <a class="btn btn-primary" href="{% url 'admin:vendas_product_add' %}">+ Cadastrar produto</a>
  {% endif %}
{% endif %}

<!-- JS simples para copiar/compartilhar -->
<script>
document.addEventListener('click', async (ev) => {
  const shareBtn = ev.target.closest('.js-share');
  const copyBtn  = ev.target.closest('.js-copy');

  // Compartilhar (Web Share API com fallback)
  if (shareBtn) {
    const url = shareBtn.dataset.url;
    const title = shareBtn.dataset.title || 'Meu produto';
    try {
      if (navigator.share) {
        await navigator.share({ title, text: 'Confira este produto:', url });
      } else if (navigator.clipboard) {
        await navigator.clipboard.writeText(url);
        shareBtn.textContent = 'Link copiado!';
        setTimeout(() => shareBtn.textContent = 'Compartilhar', 1200);
      } else {
        alert(url);
      }
    } catch(e) { /* usuário cancelou; tudo bem */ }
  }

  // Copiar (suporta botão com data-url ou input específico)
  if (copyBtn) {
    const targetSel = copyBtn.dataset.target;
    const directUrl = copyBtn.dataset.url;
    let text = directUrl;

    if (targetSel) {
      const el = document.querySelector(targetSel);
      if (el) text = el.value;
    }

    if (text) {
      try {
        await navigator.clipboard.writeText(text);
        const old = copyBtn.textContent;
        copyBtn.textContent = 'Copiado!';
        setTimeout(() => copyBtn.textContent = old, 1200);
      } catch(e) {
        // Fallback para seleção manual
        if (targetSel) {
          const el = document.querySelector(targetSel);
          if (el) {
            el.select();
            document.execCommand('copy');
            const old = copyBtn.textContent;
            copyBtn.textContent = 'Copiado!';
            setTimeout(() => copyBtn.textContent = old, 1200);
          }
        } else {
          alert(text);
        }
      }
    }
  }
});
</script>

{% endblock %}
