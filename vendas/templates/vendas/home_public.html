<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Produtos â€¢ {{ company.trade_name|default:company.corporate_name|default:"Loja Digital" }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <style>
    :root{
      --ink:#0f172a; --muted:#64748b; --ring:rgba(37,99,235,.18);
      --g1:#0b1020; --g2:#111a3a;
    }

    /* ---- anti rolagem lateral ---- */
    html, body { max-width:100%; overflow-x:hidden; }
    img, iframe { max-width:100%; height:auto; }
    .input-group { width:100%; }
    .input-group .form-control { min-width:0; }

    body{ background:#f6f8fb; color:var(--ink); }

    /* Navbar */
    .nav-lite{ background:linear-gradient(90deg,var(--g1),var(--g2)); }
    .navbar-brand{ font-weight:700; letter-spacing:.2px; }
    .brand-logo{ height:34px; width:auto; border-radius:6px; object-fit:contain; }

    /* Hero */
    .hero{
      background:
        radial-gradient(1200px 600px at -10% -10%, rgba(37,99,235,.18), transparent),
        radial-gradient(1200px 600px at 110% -10%, rgba(16,185,129,.14), transparent),
        linear-gradient(180deg,var(--g2),#0f172a);
      color:#fff;
    }
    /* tÃ­tulo menor e responsivo */
    .hero-title{
      font-weight:800;
      font-size:clamp(1.25rem, 2.5vw, 1.75rem); /* ~20px a 28px */
      line-height:1.2;
      margin:0 0 .25rem 0;
    }
    .hero .lead{ color:#cbd5e1; }

    /* Filtros */
    .search-wrap .form-control{
      border-radius:.8rem; padding:.85rem 1rem; border-color:#e2e8f0;
    }
    .search-wrap .form-control:focus{
      box-shadow:0 0 0 .25rem var(--ring); border-color:#93c5fd;
    }

    .sticky-topbar{ position: sticky; top: -1px; z-index: 20; background:#ffffffd6; backdrop-filter: blur(6px); }

    .toolbar .form-select, .toolbar .form-control{
      border-radius:.6rem; border-color:#e5e7eb;
    }
    .toolbar .form-select:focus, .toolbar .form-control:focus{
      box-shadow:0 0 0 .25rem var(--ring); border-color:#93c5fd;
    }

    /* Cards */
    .card-clean{ border:none; box-shadow:0 10px 24px rgba(17,24,39,.08); transition:transform .12s ease, box-shadow .12s ease; }
    .card-clean:hover{ transform:translateY(-2px); box-shadow:0 12px 28px rgba(17,24,39,.12); }
    .card-img-top{ aspect-ratio: 16/10; object-fit:cover; }
    .promo-badge{ position:absolute; top:.75rem; left:.75rem; }
    .price{ font-weight:800; letter-spacing:.2px; }
    .old-price{ color:#64748b; }
    .text-muted-2{ color:var(--muted); }

    /* Empty */
    .empty{
      background:#fff; border:1px dashed #cbd5e1; border-radius:12px; padding:2rem; text-align:center;
    }

    /* Footer */
    .footer-min{ color:#94a3b8; }
  </style>
</head>
<body>

<!-- NAVBAR: marca SEMPRE centralizada; aÃ§Ãµes somem no mobile -->
<nav class="navbar nav-lite navbar-dark">
  <div class="container">
    <div class="d-flex w-100 align-items-center" style="min-height:56px;">
      <!-- espaÃ§o fantasma Ã  esquerda para balancear no mobile -->
      <div class="d-md-none" style="width:48px;"></div>

      

      <!-- aÃ§Ãµes: escondidas no mobile para nÃ£o deslocar a marca -->
      <div class="ms-auto d-none d-md-flex align-items-center gap-2">
        {% if user.is_authenticated %}
          <span class="text-light small">OlÃ¡, {{ user.username }}</span>
          <a class="btn btn-outline-light btn-sm" href="{% url 'logout' %}">Sair</a>
        {% else %}
          <a class="btn btn-outline-light btn-sm" href="{% url 'login' %}">Entrar</a>
        {% endif %}
      </div>
    </div>
  </div>
</nav>

<header class="hero py-5">
  <div class="container">
    <div class="row g-4 align-items-center">
      <div class="col-lg-8 mx-auto text-center">
        <h1 class="hero-title">CatÃ¡logo de produtos</h1>
        <p class="lead mb-4">E-books, planilhas e materiais prontos para download imediato.</p>

        <div class="search-wrap">
          <div class="input-group input-group-lg">
            <span class="input-group-text bg-white border-end-0">ðŸ”Ž</span>
            <input id="q" type="search" class="form-control border-start-0" placeholder="Busque por tÃ­tulo ou descriÃ§Ã£oâ€¦" aria-label="Buscar produtos">
            <button id="btn-clear" class="btn btn-outline-secondary">Limpar</button>
          </div>
          <div class="small mt-2 text-light-emphasis">
            Use a busca e a ordenaÃ§Ã£o abaixo para encontrar o que precisa.
          </div>
        </div>
      </div>
    </div>
  </div>
</header>

<div class="sticky-topbar border-bottom py-2">
  <div class="container">
    <div class="row g-3 align-items-center toolbar justify-content-center">
      <div class="col-12 col-md-4">
        <label for="sortSel" class="form-label small text-muted-2 mb-1">Ordenar por</label>
        <select id="sortSel" class="form-select">
          <option value="featured">Destaques</option>
          <option value="newest">Mais recentes</option>
          <option value="price_asc">Menor preÃ§o</option>
          <option value="price_desc">Maior preÃ§o</option>
          <option value="title_asc">TÃ­tulo (Aâ†’Z)</option>
          <option value="title_desc">TÃ­tulo (Zâ†’A)</option>
        </select>
      </div>
    </div>
  </div>
</div>

<main class="container py-4 py-md-5">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h2 class="h5 m-0">Produtos <span class="text-muted-2 fw-normal" id="resCount"></span></h2>
  </div>

  {% if products %}
    <div id="grid" class="row g-4">
      {% for p in products %}
        {% with eff=p.price_to_charge old=p.price %}
        <div class="col-12 col-sm-6 col-lg-4 product-card"
             data-title="{{ p.title|lower }}"
             data-desc="{{ p.description|default:''|lower }}"
             data-price="{{ eff|floatformat:2 }}"
             data-created="{{ p.created_at|date:'U' }}">
          <div class="card card-clean h-100 position-relative">
            {% if p.image %}
              <img src="{{ p.image.url }}" class="card-img-top" alt="{{ p.title }}">
            {% else %}
              <div class="card-img-top d-flex align-items-center justify-content-center" style="background:#eef2f7; aspect-ratio:16/10;">
                <span class="text-muted">Sem imagem</span>
              </div>
            {% endif %}

            {% if p.has_promo %}
              <span class="badge bg-danger promo-badge">PROMO</span>
            {% endif %}

            <div class="card-body d-flex flex-column">
              <h3 class="h6 mb-1">{{ p.title }}</h3>

              {% if p.has_promo %}
                <div class="old-price small"><del>R$ {{ old|floatformat:2 }}</del></div>
              {% endif %}
              <div class="price fs-5 mb-2">R$ {{ eff|floatformat:2 }}</div>

              <p class="text-muted-2 flex-grow-1 mb-3">{{ p.description|default:""|truncatewords:24 }}</p>
              <a class="btn btn-primary w-100" href="{{ p.get_checkout_url }}">Ir ao checkout</a>
            </div>
          </div>
        </div>
        {% endwith %}
      {% endfor %}
    </div>

    <div class="text-center mt-4">
      <button id="btnMore" class="btn btn-outline-primary">Carregar mais</button>
    </div>

    <div id="empty" class="empty mt-4 d-none">
      <div class="h6 mb-1">Nenhum produto encontrado</div>
      <div class="text-muted-2">Tente alterar a busca ou a ordenaÃ§Ã£o.</div>
    </div>
  {% else %}
    <div class="empty">
      <div class="mb-2 fw-semibold">Nenhum produto disponÃ­vel no momento.</div>
      <div class="text-muted">Volte mais tarde para conferir as novidades.</div>
    </div>
  {% endif %}
</main>

<!-- RODAPÃ‰ centralizado com dados da empresa e WhatsApp -->
<footer class="py-4">
  <div class="container footer-min d-flex flex-column align-items-center text-center gap-3">
    <div class="fw-semibold">
      Â© {% now "Y" %} {{ company.trade_name|default:company.corporate_name|default:"Loja Digital" }}
    </div>

    {% if company %}
      <div>
        {% if company.cnpj %}
          CNPJ: {{ company.cnpj }}
          {% if company.address or company.phone_e164 %} â€¢ {% endif %}
        {% endif %}
        {% if company.address %}
          {{ company.address }}
          {% if company.phone_e164 %} â€¢ {% endif %}
        {% endif %}
        {% if company.phone_e164 %}
          Tel: {{ company.phone_e164 }}
        {% endif %}
      </div>

      {% if company.phone_e164 %}
        <a class="btn btn-success"
           href="https://wa.me/{{ company.phone_e164|cut:'+' }}?text={{ 'OlÃ¡! Tenho uma dÃºvida sobre os produtos.'|urlencode }}"
           target="_blank" rel="noopener">
          Falar no WhatsApp
        </a>
      {% endif %}
    {% endif %}

    <div class="small">Pagamentos via Mercado Pago â€¢ Download imediato</div>
  </div>
</footer>

<script>
(function(){
  const $q     = document.getElementById('q');
  const $clear = document.getElementById('btn-clear');
  const $sort  = document.getElementById('sortSel');
  const $grid  = document.getElementById('grid');
  const $cards = $grid ? Array.from($grid.querySelectorAll('.product-card')) : [];
  const $count = document.getElementById('resCount');
  const $empty = document.getElementById('empty');
  const $more  = document.getElementById('btnMore');

  let visible = 12;
  let filtered = [...$cards];

  function norm(s){ return (s||'').toString().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,''); }
  function priceOf(el){ return parseFloat((el.dataset.price || '0').replace(',', '.')); }
  function createdOf(el){ return parseInt(el.dataset.created || '0', 10); }
  function titleOf(el){ return el.dataset.title || ''; }

  function applyFilters(){
    const q = norm($q ? $q.value : '');
    filtered = $cards.filter(card=>{
      const t = norm(card.dataset.title);
      const d = norm(card.dataset.desc);
      return !q || t.includes(q) || d.includes(q);
    });
    applySort(); render();
  }

  function applySort(){
    const mode = $sort ? $sort.value : 'featured';
    filtered.sort((a,b)=>{
      if (mode === 'newest')     return createdOf(b) - createdOf(a);
      if (mode === 'price_asc')  return priceOf(a) - priceOf(b);
      if (mode === 'price_desc') return priceOf(b) - priceOf(a);
      if (mode === 'title_asc')  return titleOf(a).localeCompare(titleOf(b));
      if (mode === 'title_desc') return titleOf(b).localeCompare(titleOf(a));
      return 0;
    });
  }

  function render(){
    if (!$grid) return;
    $cards.forEach(c=> c.classList.add('d-none'));
    const total  = filtered.length;
    const toShow = filtered.slice(0, visible);
    toShow.forEach(c=> c.classList.remove('d-none'));

    if ($count){ $count.textContent = total ? `â€¢ ${total} resultado${total>1?'s':''}` : ''; }
    if ($empty){ $empty.classList.toggle('d-none', total !== 0); }
    if ($more){  $more.classList.toggle('d-none', visible >= total); }
  }

  $q    && $q.addEventListener('input', applyFilters);
  $sort && $sort.addEventListener('change', applyFilters);
  $clear && $clear.addEventListener('click', ()=>{
    $q && ($q.value=''); visible = 12; applyFilters(); $q && $q.focus();
  });
  $more && $more.addEventListener('click', ()=>{ visible += 12; render(); });

  applyFilters();
})();
</script>

</body>
</html>
