<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Produtos â€¢ Loja Digital</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <style>
    :root{
      --ink:#0f172a; --muted:#64748b; --ring:rgba(37,99,235,.18);
      --g1:#0b1020; --g2:#111a3a;
    }
    body{ background:#f6f8fb; color:var(--ink); }
    .nav-lite{ background:linear-gradient(90deg,var(--g1),var(--g2)); }
    .nav-lite .navbar-brand{ font-weight:700; letter-spacing:.2px; }

    .hero{
      background:
        radial-gradient(1200px 600px at -10% -10%, rgba(37,99,235,.18), transparent),
        radial-gradient(1200px 600px at 110% -10%, rgba(16,185,129,.14), transparent),
        linear-gradient(180deg,var(--g2),#0f172a);
      color:#fff;
    }
    .hero .lead{ color:#cbd5e1; }

    .search-wrap .form-control{
      border-radius:.8rem; padding:.85rem 1rem; border-color:#e2e8f0;
    }
    .search-wrap .form-control:focus{
      box-shadow:0 0 0 .25rem var(--ring); border-color:#93c5fd;
    }

    .sticky-topbar{ position: sticky; top: -1px; z-index: 20; background:#ffffffd6; backdrop-filter: blur(6px); }

    .toolbar .form-select, .toolbar .form-control{
      border-radius:.6rem; border-color:#e5e7eb;
    }
    .toolbar .form-select:focus, .toolbar .form-control:focus{
      box-shadow:0 0 0 .25rem var(--ring); border-color:#93c5fd;
    }

    .card-clean{ border:none; box-shadow:0 10px 24px rgba(17,24,39,.08); transition:transform .12s ease, box-shadow .12s ease; }
    .card-clean:hover{ transform:translateY(-2px); box-shadow:0 12px 28px rgba(17,24,39,.12); }
    .card-img-top{ aspect-ratio: 16/10; object-fit:cover; }

    .price{ font-weight:800; letter-spacing:.2px; }
    .text-muted-2{ color:var(--muted); }

    .empty{
      background:#fff; border:1px dashed #cbd5e1; border-radius:12px; padding:2rem; text-align:center;
    }

    .footer-min{ color:#94a3b8; }
  </style>
</head>
<body>

<nav class="navbar nav-lite navbar-dark">
  <div class="container d-flex align-items-center gap-3">
    <a class="navbar-brand" href="{% url 'home' %}">Loja Digital</a>
    <div class="ms-auto d-flex align-items-center gap-2">
      {% if user.is_authenticated %}
        <span class="text-light small d-none d-md-inline">OlÃ¡, {{ user.username }}</span>
        <a class="btn btn-outline-light btn-sm" href="{% url 'logout' %}">Sair</a>
      {% else %}
        <a class="btn btn-outline-light btn-sm" href="{% url 'login' %}">Entrar</a>
      {% endif %}
    </div>
  </div>
</nav>

<header class="hero py-5">
  <div class="container">
    <div class="row g-4 align-items-center">
      <div class="col-lg-8">
        <h1 class="mb-2 fw-bold">CatÃ¡logo de produtos</h1>
        <p class="lead mb-4">E-books, planilhas e materiais prontos para download imediato.</p>

        <div class="search-wrap">
          <div class="input-group input-group-lg">
            <span class="input-group-text bg-white border-end-0">ðŸ”Ž</span>
            <input id="q" type="search" class="form-control border-start-0" placeholder="Busque por tÃ­tulo ou descriÃ§Ã£oâ€¦" aria-label="Buscar produtos">
            <button id="btn-clear" class="btn btn-outline-secondary">Limpar</button>
          </div>
          <div class="small mt-2 text-light-emphasis">
            Use a busca e os filtros abaixo para encontrar o que precisa.
          </div>
        </div>
      </div>
    </div>
  </div>
</header>

<div class="sticky-topbar border-bottom py-2">
  <div class="container">
    <div class="row g-3 align-items-center toolbar">
      
      <div class="col-12 col-md-4">
        <label for="sortSel" class="form-label small text-muted-2 mb-1">Ordenar por</label>
        <select id="sortSel" class="form-select">
          <option value="featured">Destaques</option>
          <option value="newest">Mais recentes</option>
          <option value="price_asc">Menor preÃ§o</option>
          <option value="price_desc">Maior preÃ§o</option>
          <option value="title_asc">TÃ­tulo (Aâ†’Z)</option>
          <option value="title_desc">TÃ­tulo (Zâ†’A)</option>
        </select>
      </div>
    </div>
  </div>
</div>

<main class="container py-4 py-md-5">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h2 class="h5 m-0">Produtos <span class="text-muted-2 fw-normal" id="resCount"></span></h2>
  </div>

  {% if products %}
    <div id="grid" class="row g-4">
      {% for p in products %}
        <div class="col-12 col-sm-6 col-lg-4 product-card"
             data-title="{{ p.title|lower }}"
             data-desc="{{ p.description|default:''|lower }}"
             data-price="{{ p.price|floatformat:2 }}"
             data-created="{{ p.created_at|date:'U' }}">
          <div class="card card-clean h-100">
            {% if p.image %}
              <img src="{{ p.image.url }}" class="card-img-top" alt="{{ p.title }}">
            {% else %}
              <div class="card-img-top d-flex align-items-center justify-content-center" style="background:#eef2f7;">
                <span class="text-muted">Sem imagem</span>
              </div>
            {% endif %}
            <div class="card-body d-flex flex-column">
              <h3 class="h6 mb-1">{{ p.title }}</h3>
              <div class="price fs-5 mb-2">R$ {{ p.price }}</div>
              <p class="text-muted-2 flex-grow-1 mb-3">{{ p.description|default:""|truncatewords:24 }}</p>
              <a class="btn btn-primary w-100" href="{{ p.get_checkout_url }}">Ir ao checkout</a>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>

    <div class="text-center mt-4">
      <button id="btnMore" class="btn btn-outline-primary">Carregar mais</button>
    </div>

    <div id="empty" class="empty mt-4 d-none">
      <div class="h6 mb-1">Nenhum produto encontrado</div>
      <div class="text-muted-2">Tente alterar os filtros ou limpar a busca.</div>
    </div>
  {% else %}
    <div class="empty">
      <div class="mb-2 fw-semibold">Nenhum produto disponÃ­vel no momento.</div>
      <div class="text-muted">Volte mais tarde para conferir as novidades.</div>
    </div>
  {% endif %}
</main>

<footer class="py-4">
  <div class="container d-flex flex-wrap justify-content-between align-items-center footer-min">
    <div>Â© {{ now|date:"Y" }} Loja Digital</div>
    <div class="small">Pagamentos via Mercado Pago â€¢ Download imediato</div>
  </div>
</footer>

<script>
(function(){
  const $q        = document.getElementById('q');
  const $clear    = document.getElementById('btn-clear');
  const $min      = document.getElementById('minPrice');
  const $max      = document.getElementById('maxPrice');
  const $sort     = document.getElementById('sortSel');
  const $grid     = document.getElementById('grid');
  const $cards    = $grid ? Array.from($grid.querySelectorAll('.product-card')) : [];
  const $count    = document.getElementById('resCount');
  const $empty    = document.getElementById('empty');
  const $more     = document.getElementById('btnMore');

  let visible = 12; // itens exibidos inicialmente
  let filtered = [...$cards];

  function norm(s){ return (s||'').toString().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,''); }
  function priceOf(el){ return parseFloat(el.dataset.price || '0'); }
  function createdOf(el){ return parseInt(el.dataset.created || '0', 10); }
  function titleOf(el){ return el.dataset.title || ''; }

  function applyFilters(){
    const q   = norm($q ? $q.value : '');
    const pmin= parseFloat($min && $min.value ? $min.value : '-1');
    const pmax= parseFloat($max && $max.value ? $max.value : '100000000');

    filtered = $cards.filter(card=>{
      const t = norm(card.dataset.title);
      const d = norm(card.dataset.desc);
      const inText = !q || t.includes(q) || d.includes(q);
      const p = priceOf(card);
      const inPrice = (isNaN(pmin) || p >= pmin) && (isNaN(pmax) || p <= pmax);
      return inText && inPrice;
    });

    applySort();
    render();
  }

  function applySort(){
    const mode = $sort ? $sort.value : 'featured';
    filtered.sort((a,b)=>{
      if (mode === 'newest')     return createdOf(b) - createdOf(a);
      if (mode === 'price_asc')  return priceOf(a) - priceOf(b);
      if (mode === 'price_desc') return priceOf(b) - priceOf(a);
      if (mode === 'title_asc')  return titleOf(a).localeCompare(titleOf(b));
      if (mode === 'title_desc') return titleOf(b).localeCompare(titleOf(a));
      return 0;
    });
  }

  function render(){
    if (!$grid) return;
    $cards.forEach(c=> c.classList.add('d-none'));
    const total = filtered.length;
    const toShow = filtered.slice(0, visible);
    toShow.forEach(c=> c.classList.remove('d-none'));

    if ($count){
      $count.textContent = total ? `â€¢ ${total} resultado${total>1?'s':''}` : '';
    }
    if ($empty){
      $empty.classList.toggle('d-none', total !== 0);
    }
    if ($more){
      $more.classList.toggle('d-none', visible >= total);
    }
  }

  // eventos
  $q   && $q.addEventListener('input', applyFilters);
  $min && $min.addEventListener('input', applyFilters);
  $max && $max.addEventListener('input', applyFilters);
  $sort&& $sort.addEventListener('change', applyFilters);

  $clear && $clear.addEventListener('click', ()=>{
    $q && ($q.value='');
    $min && ($min.value='');
    $max && ($max.value='');
    visible = 12;
    applyFilters();
    $q && $q.focus();
  });

  $more && $more.addEventListener('click', ()=>{
    visible += 12;
    render();
  });

  // inicializa
  applyFilters();
})();
</script>

</body>
</html>
